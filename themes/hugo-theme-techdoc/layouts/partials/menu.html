<nav>
{{- $currentNode := . -}}
{{- $showvisitedlinks := .Site.Params.showVisitedLinks -}}
<ul>
  <li class="{{if .IsHome}}active{{end}}"><a href="{{ .Site.BaseURL }}">Home</a></li>
  {{- if eq .Site.Params.ordersectionsby "title" -}}
    {{- range .Site.Home.Sections.ByTitle -}}
    {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
    {{- end -}}
  {{- else -}}
    {{- range .Site.Home.Sections.ByWeight -}}
    {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
    {{- end -}}
  {{- end -}}
</ul>
</nav>

<!-- templates -->
{{- define "section-tree-nav" -}}
{{- $showvisitedlinks := .showvisitedlinks -}}
{{- $currentNode := .currentnode -}}
 {{- with .sect -}}
  {{- if .IsSection -}}
    {{- safeHTML .Params.head -}}
    <li class="{{if .IsAncestor $currentNode }} parent{{end}}{{if eq .UniqueID $currentNode.UniqueID}} active{{end}}{{if .Params.alwaysopen}} parent{{end}}"><a href="{{.RelPermalink}}">{{safeHTML .Params.Pre}}{{.Title}}{{safeHTML .Params.Post}}</a>
      {{- $numberOfPages := (add (len .Pages) (len .Sections)) -}}
      {{- if ne $numberOfPages 0 -}}
        <ul>
          {{- .Scratch.Set "pages" .Pages -}}
          {{- if .Sections -}}
            {{- .Scratch.Set "pages" (.Pages | union .Sections) -}}
          {{- end -}}
          {{- $pages := (.Scratch.Get "pages") -}}

        {{- if eq .Site.Params.ordersectionsby "title" -}}
          {{- range $pages.ByTitle -}}
            {{- if and .Params.hidden (not $.showhidden) -}}
            {{- else -}}
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
            {{- end -}}
          {{- end -}}
        {{- else -}}
          {{- range $pages.ByWeight -}}
            {{- if and .Params.hidden (not $.showhidden) -}}
            {{- else -}}
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
        </ul>
      {{- end -}}
    </li>
  {{- else -}}
    {{- if not .Params.Hidden -}}
<li class="{{if eq .UniqueID $currentNode.UniqueID}}active{{end}}"><a href="{{ .RelPermalink }}">{{safeHTML .Params.Pre}}{{.Title}}{{safeHTML .Params.Post}}</a></li>
    {{- end -}}
  {{- end -}}
 {{- end -}}
{{- end -}}
